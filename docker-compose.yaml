x-base: &base
  network_mode: host
  volumes:
    - /etc/localtime:/etc/localtime:ro
  logging:
    driver: "json-file"
    options:
      max-size: "${MAX_LOG_FILE_SIZE:-10m}"
      max-file: "${MAX_LOG_FILE_COUNT:-3}"
      tag: "{{.Name}}|{{.ImageName}}|{{.ID}}"

x-redis-node: &redis-node
  <<: *base
  image: "redis:${REDIS_VERSION:-latest}"
  restart: unless-stopped
  entrypoint:
    - /usr/local/bin/redis-server
    - --bind
    - "${REDIS_BIND_ADDRESS:-127.0.0.1}"
    - --cluster-enabled
    - "yes"
    - --cluster-config-file
    - "nodes.conf"
    - --cluster-node-timeout
    - "5000"
    - --appendonly
    - "${REDIS_APPENDONLY:-no}"
    - --appendfsync
    - "${REDIS_APPENDFSYNC:-everysec}"
    - --save
    - "${REDIS_SAVE:-900 1 300 10 60 10000}"
    - --maxmemory
    - "${REDIS_MAXMEMORY:-256mb}"
    - --maxmemory-policy
    - "${REDIS_MAXMEMORY_POLICY:-allkeys-lru}"
  healthcheck:
    interval: 3s
    timeout: 1s
    retries: 10
    start_period: 3s
  deploy:
    resources:
      limits:
        cpus: "${REDIS_CPU_LIMIT:-1.0}"
        memory: "${REDIS_MEMORY_LIMIT:-512M}"

services:
  redis-node-1:
    <<: *redis-node
    command: ["--port", "${REDIS_PORT_1:-7001}"]
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${REDIS_PORT_1:-7001}", "ping"]
    volumes:
      - redis_node_1_data:/data

  redis-node-2:
    <<: *redis-node
    command: ["--port", "${REDIS_PORT_2:-7002}"]
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${REDIS_PORT_2:-7002}", "ping"]
    volumes:
      - redis_node_2_data:/data

  redis-node-3:
    <<: *redis-node
    command: ["--port", "${REDIS_PORT_3:-7003}"]
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${REDIS_PORT_3:-7003}", "ping"]
    volumes:
      - redis_node_3_data:/data

  redis-node-4:
    <<: *redis-node
    command: ["--port", "${REDIS_PORT_4:-7004}"]
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${REDIS_PORT_4:-7004}", "ping"]
    volumes:
      - redis_node_4_data:/data

  redis-node-5:
    <<: *redis-node
    command: ["--port", "${REDIS_PORT_5:-7005}"]
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${REDIS_PORT_5:-7005}", "ping"]
    volumes:
      - redis_node_5_data:/data

  redis-node-6:
    <<: *redis-node
    command: ["--port", "${REDIS_PORT_6:-7006}"]
    healthcheck:
      test: ["CMD", "redis-cli", "-p", "${REDIS_PORT_6:-7006}", "ping"]
    volumes:
      - redis_node_6_data:/data

  redis-cluster-init:
    <<: *base
    image: "redis:${REDIS_VERSION:-latest}"
    restart: on-failure
    command: |
      sh -c "until
        redis-cli -p ${REDIS_PORT_1:-7001} ping > /dev/null 2>&1 &&
        redis-cli -p ${REDIS_PORT_2:-7002} ping > /dev/null 2>&1 &&
        redis-cli -p ${REDIS_PORT_3:-7003} ping > /dev/null 2>&1 &&
        redis-cli -p ${REDIS_PORT_4:-7004} ping > /dev/null 2>&1 &&
        redis-cli -p ${REDIS_PORT_5:-7005} ping > /dev/null 2>&1 &&
        redis-cli -p ${REDIS_PORT_6:-7006} ping > /dev/null 2>&1;
      do
        echo 'Waiting for nodes...'
        sleep 1
      done
      CLUSTER_STATE=\$$(redis-cli -p ${REDIS_PORT_1:-7001} cluster info | grep cluster_state | cut -d: -f2 | tr -d '\\r')
      if [ \"\$$CLUSTER_STATE\" = \"ok\" ]; then
        echo 'Cluster already exists'
      else
        echo 'Creating cluster...'
        redis-cli --cluster create \\
          127.0.0.1:${REDIS_PORT_1:-7001} 127.0.0.1:${REDIS_PORT_2:-7002} 127.0.0.1:${REDIS_PORT_3:-7003} \\
          127.0.0.1:${REDIS_PORT_4:-7004} 127.0.0.1:${REDIS_PORT_5:-7005} 127.0.0.1:${REDIS_PORT_6:-7006} \\
          --cluster-replicas 1 --cluster-yes
      fi"
    depends_on:
      redis-node-1:
        condition: service_healthy
      redis-node-2:
        condition: service_healthy
      redis-node-3:
        condition: service_healthy
      redis-node-4:
        condition: service_healthy
      redis-node-5:
        condition: service_healthy
      redis-node-6:
        condition: service_healthy

  redis-commander:
    <<: *base
    image: ghcr.io/joeferner/redis-commander:${REDIS_COMMANDER_VERSION:-latest}
    restart: unless-stopped
    environment:
      ADDRESS: "${REDIS_COMMANDER_BIND_ADDRESS:-127.0.0.1}"
      PORT: "${REDIS_COMMANDER_PORT:-18081}"
      REDIS_LABEL: redis-cluster
      CLUSTERS: 127.0.0.1:${REDIS_PORT_1:-7001},127.0.0.1:${REDIS_PORT_2:-7002},127.0.0.1:${REDIS_PORT_3:-7003},127.0.0.1:${REDIS_PORT_4:-7004},127.0.0.1:${REDIS_PORT_5:-7005},127.0.0.1:${REDIS_PORT_6:-7006}
      IS_CLUSTER: true
    depends_on:
      redis-cluster-init:
        condition: service_completed_successfully
    deploy:
      resources:
        limits:
          cpus: "${REDIS_COMMANDER_CPU_LIMIT:-0.5}"
          memory: "${REDIS_COMMANDER_MEMORY_LIMIT:-256M}"

volumes:
  redis_node_1_data:
  redis_node_2_data:
  redis_node_3_data:
  redis_node_4_data:
  redis_node_5_data:
  redis_node_6_data:
